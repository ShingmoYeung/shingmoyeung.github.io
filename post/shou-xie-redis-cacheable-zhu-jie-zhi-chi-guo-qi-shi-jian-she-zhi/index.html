<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>手写Redis @Cacheable注解 支持过期时间设置 | 代码人生</title>
<link rel="shortcut icon" href="https://jkju7q.coding-pages.com/favicon.ico?v=1587199452611">
<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.css" rel="stylesheet">
<link rel="stylesheet" href="https://jkju7q.coding-pages.com/styles/main.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

<script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/go.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            代码人生
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
                <div class="nav-item">
                    
                        <a href="/" class="menu gt-a-link">
                            首页
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/archives" class="menu gt-a-link">
                            归档
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/tags" class="menu gt-a-link">
                            标签
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/about" class="menu gt-a-link">
                            关于
                        </a>
                    
                </div>
            
        </div>
    </div>
</nav>
    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    手写Redis @Cacheable注解 支持过期时间设置
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2019-09-07 20:13 ·
                    </time>
                    
                        <a href="https://jkju7q.coding-pages.com/tag/dai-ma-na-xie-shi-er/" class="post-tags">
                            # 代码那些事儿
                        </a>
                    
                        <a href="https://jkju7q.coding-pages.com/tag/redis/" class="post-tags">
                            # Redis
                        </a>
                    
                        <a href="https://jkju7q.coding-pages.com/tag/BJd4x8aTJ/" class="post-tags">
                            # 2019-09
                        </a>
                    
                </div>
                <div class="post-content">
                    <h2 id="原理解释">原理解释</h2>
<h4 id="友情链接-a-hrefhttpsblogcsdnnetxiewenfeng520articledetails84864120-target_blank手写redis-cacheable注解参数java对象作为键值a">友情链接  <a href="https://blog.csdn.net/xiewenfeng520/article/details/84864120" target="_blank">手写Redis @Cacheable注解参数java对象作为键值</a></h4>
<p>@Cacheable注解作用，将带有该注解方法的返回值存放到redis的的中;</p>
<p>使用方法在方法上使用@Cacheable（键=“测试+＃P0 + P1＃...”）</p>
<p>表示键值为测试+方法第一个参数+方法第二个参数，值值为该方法的返回值。</p>
<p>以下源代码表示获取人员列表，Redis的中存放的关键值为'领袖'+ leaderGroupId + UUID + yearDetailId</p>
<pre><code class="language-java">    @Override
	@Cacheable(key=&quot;'leader'+#p0+#p1+#p2&quot;,value=&quot;leader&quot;)
	public List&lt;Leader&gt; listLeaders(String leaderGroupId, String uuid, String yearDetailId) {
		return sysIndexMapper.listLeaders(leaderGroupId, uuid, yearDetailId);
	}
</code></pre>
<p>等同于</p>
<pre><code class="language-java">    @Override
	public List&lt;Leader&gt; listLeaders(String leaderGroupId, String uuid, String yearDetailId) {
		String key = &quot;leader&quot; + leaderGroupId + uuid + yearDetailId;
		// 判断缓存是否存在redis中
		boolean hasKey = redisUtil.hasKey(key);
		if (hasKey) {
            //如果存在 返还redis中的值
			Object leadersList = redisUtil.get(key);
			return (List&lt;Leader&gt;) leadersList;
		} else {
			List&lt;Leader&gt; leadersQuotaDetailList = sysIndexMapper.listLeaders(leaderGroupId, uuid, yearDetailId);
            //将查询结果存放在redis中
			redisUtil.set(key, leadersQuotaDetailList);
			return leadersQuotaDetailList;
		}
	}
    ```
说白了就是在原方法的前面判断的关键值是否存在的Redis的中，如果存在就取内存中的值，如果不存在就查询数据库，将查询结果存放在Redis的的中。

#### 实现方法
使用代理模式，在方法执行前和执行后可以添加其他处理程序，本文采用springAOP +注解方式。
集成Redis，封装Redis工具类
原版本不支持关键过期时间设置，本文将实现
源代码
缓存配置类RedisConfig
```java
    package com.huajie.config;

    import org.springframework.beans.factory.annotation.Value;

    import org.springframework.cache.CacheManager;

    import org.springframework.cache.annotation.CachingConfigurerSupport;

    import org.springframework.cache.annotation.EnableCaching;

    import org.springframework.cache.interceptor.KeyGenerator;

    import org.springframework.context.annotation.Bean;

    import org.springframework.context.annotation.Configuration;

    import org.springframework.data.redis.cache.RedisCacheManager;

    import org.springframework.data.redis.connection.RedisConnectionFactory;

    import org.springframework.data.redis.core.RedisTemplate;

    import org.springframework.data.redis.core.StringRedisTemplate;

    import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;

    import org.springframework.data.redis.serializer.StringRedisSerializer;

    import com.fasterxml.jackson.annotation.JsonAutoDetect;

    import com.fasterxml.jackson.annotation.PropertyAccessor;

    import com.fasterxml.jackson.databind.ObjectMapper;

    

    /**

    * Redis缓存配置类

    */

    @Configuration

    @EnableCaching

    public class RedisConfig extends CachingConfigurerSupport {

 

	@Value(&quot;${spring.redis.host}&quot;)

	private String host;

	@Value(&quot;${spring.redis.port}&quot;)

	private int port;

	@Value(&quot;${spring.redis.timeout}&quot;)

	private int timeout;

 

	// 自定义缓存key生成策略

	@Bean

	public KeyGenerator keyGenerator() {

		return new KeyGenerator() {

			@Override

			public Object generate(Object target, java.lang.reflect.Method method, Object... params) {

				StringBuffer sb = new StringBuffer();

				sb.append(target.getClass().getName());

				sb.append(method.getName());

				for (Object obj : params) {

					sb.append(obj.toString());

				}

				return sb.toString();

			}

		};

	}

 

	// 缓存管理器

	@Bean

	public CacheManager cacheManager(@SuppressWarnings(&quot;rawtypes&quot;) RedisTemplate redisTemplate) {

		RedisCacheManager cacheManager = new RedisCacheManager(redisTemplate);

		// 设置缓存过期时间

		cacheManager.setDefaultExpiration(10000);

		return cacheManager;

	}

 

	@Bean

	public RedisTemplate&lt;String, Object&gt; redisTemplate(RedisConnectionFactory factory) {

		RedisTemplate&lt;String, Object&gt; template = new RedisTemplate&lt;String, Object&gt;();

		template.setConnectionFactory(factory);

		Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);

		ObjectMapper om = new ObjectMapper();

		om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);

		om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);

		jackson2JsonRedisSerializer.setObjectMapper(om);

		StringRedisSerializer stringRedisSerializer = new StringRedisSerializer();

		// key采用String的序列化方式

		template.setKeySerializer(stringRedisSerializer);

		// hash的key也采用String的序列化方式

		template.setHashKeySerializer(stringRedisSerializer);

		// value序列化方式采用jackson

		template.setValueSerializer(jackson2JsonRedisSerializer);

		// hash的value序列化方式采用jackson

		template.setHashValueSerializer(jackson2JsonRedisSerializer);

		template.afterPropertiesSet();

		return template;

	}

 
	private void setSerializer(StringRedisTemplate template) {

		@SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })

		Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);

		ObjectMapper om = new ObjectMapper();

		om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);

		om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);

		jackson2JsonRedisSerializer.setObjectMapper(om);

		template.setValueSerializer(jackson2JsonRedisSerializer);

	}
}
</code></pre>
<p>Redis的依赖引入，配置文件，工具类RedisUtil，网上几个版本都类似，本文参考以下版本传送门</p>
<p>https://www.cnblogs.com/zeng1994/p/03303c805731afc9aa9c60dbbd32a323.html</p>
<p>准备工作做好之后开始正式编写注解@Cacheable nextkey（）用做二级缓存本文中不会用到</p>
<p>nextKey用法详情&gt; 设计模式（实战） - 责任链模式 &lt;</p>
<p>创建的Java的注解@ExtCacheable</p>
<pre><code class="language-java">    package com.huajie.annotation;

    import java.lang.annotation.ElementType;

    import java.lang.annotation.Retention;

    import java.lang.annotation.RetentionPolicy;

    import java.lang.annotation.Target;

    
    @Target({ ElementType.METHOD })
    @Retention(RetentionPolicy.RUNTIME)
    public @interface ExtCacheable {

	String key() default &quot;&quot;;

	String nextKey() default &quot;&quot;;

	int expireTime() default 1800;//30分钟

}
</code></pre>
<p>SpringAop切面CacheableAspect</p>
<pre><code class="language-java">    package com.huajie.aspect;

    import java.lang.reflect.Method;

    import java.util.ArrayList;

    import java.util.List;

    import org.aspectj.lang.ProceedingJoinPoint;

    import org.aspectj.lang.annotation.Around;

    import org.aspectj.lang.annotation.Aspect;

    import org.aspectj.lang.annotation.Pointcut;

    import org.aspectj.lang.reflect.MethodSignature;

    import org.springframework.beans.factory.annotation.Autowired;

    import org.springframework.stereotype.Component;

    import com.huajie.annotation.ExtCacheable;

    import com.huajie.utils.RedisUtil;

    

    /**

     * redis缓存处理

     * 不适用与内部方法调用(this.)或者private

    */

    @Component

    @Aspect

    public class CacheableAspect {

	

	@Autowired

	private RedisUtil redisUtil;

 

	@Pointcut(&quot;@annotation(com.huajie.annotation.ExtCacheable)&quot;)

	public void annotationPointcut() {

	}

 

	@Around(&quot;annotationPointcut()&quot;)

	public Object doAround(ProceedingJoinPoint joinPoint) throws Throwable {

		// 获得当前访问的class

		Class&lt;?&gt; className = joinPoint.getTarget().getClass();

		// 获得访问的方法名

		String methodName = joinPoint.getSignature().getName();

		// 得到方法的参数的类型

		Class&lt;?&gt;[] argClass = ((MethodSignature) joinPoint.getSignature()).getParameterTypes();

		Object[] args = joinPoint.getArgs();

		String key = &quot;&quot;;

		int expireTime = 1800;

		try {

			// 得到访问的方法对象

			Method method = className.getMethod(methodName, argClass);

			method.setAccessible(true);

			// 判断是否存在@ExtCacheable注解

			if (method.isAnnotationPresent(ExtCacheable.class)) {

				ExtCacheable annotation = method.getAnnotation(ExtCacheable.class);

				key = getRedisKey(args,annotation);

				expireTime = getExpireTime(annotation);

			}

		} catch (Exception e) {

			throw new RuntimeException(&quot;redis缓存注解参数异常&quot;, e);

		}

		// 获取缓存是否存在

		boolean hasKey = redisUtil.hasKey(key);

		if (hasKey) {

			return redisUtil.get(key);

		} else {

                         //执行原方法（java反射执行method获取结果）

			Object res = joinPoint.proceed();

                         //设置缓存

			redisUtil.set(key, res);

                         //设置过期时间

			redisUtil.expire(key, expireTime);

			return res;

		}

	}

	

	private int getExpireTime(ExtCacheable annotation) {

		return annotation.expireTime();

	}

 

	private String getRedisKey(Object[] args,ExtCacheable annotation) {

		String primalKey = annotation.key();

		//获取#p0...集合

		List&lt;String&gt; keyList = getKeyParsList(primalKey);

		for (String keyName : keyList) {

			int keyIndex = Integer.parseInt(keyName.toLowerCase().replace(&quot;#p&quot;, &quot;&quot;));

			Object parValue = args[keyIndex];

			primalKey = primalKey.replace(keyName, String.valueOf(parValue));

		}

		return primalKey.replace(&quot;+&quot;,&quot;&quot;).replace(&quot;'&quot;,&quot;&quot;);

	}

 

	// 获取key中#p0中的参数名称

	private static List&lt;String&gt; getKeyParsList(String key) {

		List&lt;String&gt; ListPar = new ArrayList&lt;String&gt;();

		if (key.indexOf(&quot;#&quot;) &gt;= 0) {

			int plusIndex = key.substring(key.indexOf(&quot;#&quot;)).indexOf(&quot;+&quot;);

			int indexNext = 0;

			String parName = &quot;&quot;;

			int indexPre = key.indexOf(&quot;#&quot;);

			if(plusIndex&gt;0){

				indexNext = key.indexOf(&quot;#&quot;) + key.substring(key.indexOf(&quot;#&quot;)).indexOf(&quot;+&quot;);

				parName = key.substring(indexPre, indexNext);

			}else{

				parName = key.substring(indexPre);

			}

			ListPar.add(parName.trim());

			key = key.substring(indexNext + 1);

			if (key.indexOf(&quot;#&quot;) &gt;= 0) {

				ListPar.addAll(getKeyParsList(key));

			}

		}

		return ListPar;

	}
}
</code></pre>
<p>业务模块使用方法</p>
<pre><code class="language-java">    @Override
	@ExtCacheable(key = &quot;Leaders+#p0+#p1+#p2&quot;)
	// 手机端获取领导人员列表
	public List&lt;Leader&gt; listLeaders(String leaderGroupId, String uuid, String yearDetailId) {
		List&lt;Leader&gt; leadersQuotaDetailList = sysIndexMapper.listLeaders(leaderGroupId, uuid, yearDetailId);
		return leadersQuotaDetailList;
}
</code></pre>
<p>业务模块过期时间使用方法，5分钟过期</p>
<pre><code class="language-java">    @Override
	@ExtCacheable(key = &quot;mobileCacheFlag&quot;, expireTime = 60 * 5)
	public int cacheFlag() {
		int mobileCacheFlag = 1;
		mobileCacheFlag = sysIndexMapper.cacheFlag();
		return mobileCacheFlag;

}
</code></pre>
<p>Redis的的截图<br>
<img src="https://jkju7q.coding-pages.com/post-images/1569586808296.png" alt="" loading="lazy"></p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://jkju7q.coding-pages.com/post/executors-java-bian-cheng-gui-fan-cha-jian-ti-shi-shou-dong-chuang-jian-xian-cheng-chi-de-jie-jue-ban-fa/" class="post-title gt-a-link">
                    Executors Java编程规范插件提示手动创建线程池的解决办法
                </a>
            </div>
        

        
            

            
                <link rel="stylesheet" href="https://unpkg.com/disqusjs@1.1/dist/disqusjs.css">
<script src="https://unpkg.com/disqusjs@1.1/dist/disqus.js"></script>

<div id="disqus_thread"></div>

<script>

var options = {
  shortname: 'codingforever',
  apikey: 'Ex7kW5Rj5HlJfSXMDpiO2xzYENfMTeEKV4zLTfgXca2XHftV9fzfjVwrLdrbd16T',
}
if ('') {
  options.api = ''
}
var dsqjs = new DisqusJS(options)

</script>

            
        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">代码 人生 感悟 分享</div>
    <div class="social-container">
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Powered by <a href="https://codingforever.cn" target="_blank">The Code of Life</a>
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://jkju7q.coding-pages.com/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
    hljs.initHighlightingOnLoad()
</script>


    </div>
</div>
</body>
</html>
